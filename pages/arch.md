Описание архитектуры
====================

Здесь представлено описание взаимодействия частей системы в процессе обработки
запроса.

Шаг 1
-----
    
![Шаг 1](/images/arch-step-1.png)
    
На первом шаге создаётся экземпляр менеджера ресурсов. Он предназначен для 
инициализации и обращения к различным активным элементами архитектуры (для 
простоты будем называть их ресурсами). Причём реальные экземпляры ресурсов 
создаются лишь в момент первого обращения к ним, а в дальнейшем ссылка на этот 
экземпляр сохраняется в менеджере. Таким образом реализуется механизм поздней 
загрузки, одновременно остающийся прозрачным для других частей системы и 
инкапсулированный внутри одной абстракции.

При создании менеджеру ресурсов 
передаётся конфигурация системы, то есть параметры настройки, влияющие на 
поведение системы в конкретном рабочем окружении. Перечислим эти параметры:

* режим работы системы;

    позволяет выбирать режим функционирования системы: в режиме отладки или в 
    рабочем режиме. Первый спользуется в процессе разработки, он позволяет 
    выявлять ошибки в коде, отображая отладочную информацию о процессе работы 
    системы (дерево вызовов, аргументы функций и методов и т.д.). Во втором 
    режиме отладочная информация не отображается  пользователям системы 
    (поскольку она не должна попадать посторонним с точки зрения безопасности 
    функционирования сервера), но записывается в специальный файл журнала, 
    которой впоследствии может быть проанализирован системным администратором.

* адрес сайта;

    базовый адрес сайта, который будет в дальнейшем использоваться системой при 
    генерации ссылок на сайте и в почтовых сообщениях, отправляемых 
    пользователям.
    
* настройки соединения с базой данных;
    
    сюда входят такие параметры, как СУБД, с которой будет осушествляться 
    работа, сервер, имя пользователя, пароль. Допольнительно могут быть указаны 
    опции, специфичные для какой-то либо конкретной СУБД.
    
* маршруты;

    маршруты позволяют связывать запросы к веб-серверу с их непосредственными 
    обработчиками в коде разрабатываемого приложения.

* права доступа пользователей;

    в зависимости от ролей пользователей в системе они имеют доступ к 
    определённому набору страниц. Этот параметр служит для установления 
    ассоциаций между ролями пользователей и обработчиками запросов (парами 
    "контроллер-действие"), к которым пользователю разрешён доступ.
        
* строка для шифрования данных авторизации;
    
    пароли пользователей и некоторая другая информация, являющаяся 
    чувствительной с точки зрения безопасности, сохраняется в базе с помощью 
    необратимого алгоритма шифрования (хеширования), чтобы в случае, если 
    потенциальный злоумышленник сможет считать такого рода информацию из базы 
    данных, он не получил полного контроля над учётными записями пользователей. 
    Для усиления хеш-функции применяется строка, состоящая из случайных 
    символов, привносящая дополнительные степень неопределённость и, 
    следовательно, стойкость к перебору в получаемые хеши.

* настройки отправки почтовых сообщений.

    в процессе работы с системой пользователям могут отправлять электронные 
    почтовые сообщения. Данный параметр задаёт такие настройки, как используемый
    для отправки транспорт (локальный агент передачи почты или удалённый 
    SMTP-сервер), адрес и имя отправителя, данные для авторизации на 
    SMTP-сервере (если выбран соответствующий транспорт).

В целом, менеджер ресурсов представляет собой реализацию одной из форм активной 
инверсии зависимостей в коде, используемых при построении 
объектно-ориентированных систем. Эта форма называется "dependency lookup: pull 
approach" и предполагает наличие в системе общедоступного объекта, который 
знает обо всех используемых сервисах. Таким образом все зависимости 
инкапсулируются внутри этого объекта и остальные части системы могут 
запрашивать по мере необходимые сервисы у него. [[1]]
[agiledev]

Шаг 2
-----
    
![Шаг 2](/images/arch-step-2.png)

На втором шаге создается экземпляр диспетчера запросов. Его предназначение 
состоит в том, чтобы при помощи маршрутизатора и сервиса авторизации 
делегировать управление необходимому в данный момент обработчику. Посколько 
систему построена с использованием парадигмы MVC, то обработчиками запросов в 
данном случае выступают контроллеры, а точнее отдельные их действия.

Шаг 3
-----
    
![Шаг 3](/images/arch-step-3.png)

    @todo Блин... Куки... Как-то не очень звучит +) Может можно подобрать 
    термин посерьёзнее? :)
    
    @todo Расписать про кукисы - [2]

Создаётся контейнер, содержащий практически всю информацию о запросе к 
веб-серверу. Сюда входят данные, переданные браузером пользователя 
HTTP-методами GET и POST, куки и переменные окружения веб-сервера. Такой 
контейнер создаёт дополнительный слой абстракции для системы, позволяя собрать 
зависимости различных частей от глобальных переменных, содержащих данные о 
запросе, в одной и поэтому легко контролируемой сущности. И этот контейнер 
передаётся для обработки диспетчеру запросов.

Шаг 4
-----
    
![Шаг 4](/images/arch-step-4.png)

На четвёртом шаге порождается экземпляр маршрутизатора, задачей которого 
является поиск среди настроенных в конфигурационных данных маршрута, шаблон 
которого совпадает с текущей запрашиваемой страницей.

    @todo Расписать про регексы - [3]

Маршрут состоит из следующих полей данных:

* алиас

    краткое обозначение маршрута.
    
* тип

    статичный или с использованием регулярных выражений.

* шаблон

    для установления соответствия строки запроса и маршрута
    
* обработчик

    контроллер-действие

* параметры

    данные извлекаемые из запроса или заданные вручную для маршрута и 
    передаваемые в обработчик

Шаг 5
-----
    
![Шаг 5](/images/arch-step-5.png)

Проверяется, закрыт ли публичный доступ к запрашиваемой странице, и если да, то 
опрашивается сервис авторизации на предмет наличия у текущего пользователя 
необходимых прав на доступ.

Шаг 6
-----
    
![Шаг 6](/images/arch-step-6.png)

Диспетчер загружает код соответствующего класса-контроллера, создаёт его 
экземпляр и передаёт управление одному из его методов, реализующих запрошенное 
действие, вместе со списком параметров.

Шаг 7
-----
    
![Шаг 7](/images/arch-step-7.png)

Выполняется запрошенное действие контроллера. В процессе контроллер может 
делать вызовы методов модели. Модели служат для представления 
предметно-ориентированных данных и манипулирования ими. Основная их работа 
связана с объектом взаимодейтсвия с базой данных, ссылку на которой они 
получают через менеджер ресурсов. 

    @todo Расписать про PDO - [4], [5]

Также контроллер может обращаться к вспомогательному объекту формы, который 
упрощает взаимодействие с HTTP-формами.

    @todo Расписать про формы - [6]

Шаг 8
-----
    
![Шаг 8](/images/arch-step-8.png)

Кроме того, контроллер может обращаться к сервису авторизации для реализации 
дополнительной логики на основе данных текущего пользователя, например, его 
роли в системе.

А также контроллер может использовать менеджер ссылок. Он позволяет получать 
ссылки на различные страницы системы на основе настроенных маршрутов.

Обращение к обоим объектам происходит через менеджер ресурсов.

Шаг 9
-----
    
![Шаг 9](/images/arch-step-9.png)

В ходе выполнения действия контроллера создаётся набор переменных, которые будут
переданы представлению. После завершения работы контроллер запрашивает у 
менеджера ресурсов объект отображения шаблонов, которому передаётся управление 
вместе со сформированным набором переменных. Затем происходит обработка 
шаблонов трёх уровней (шаблон страницы, шаблоны элементов и шаблон макета) и 
выдача пользователю сформированной страницы.

Шаг 10
-----
    
![Шаг 10](/images/arch-step-10.png)

В процессе обработки шаблонов представления могут, как и в случае работы 
контроллеров, вызываться (опять же через менеджер ресурсов) менеджер ссылок и 
объекты форм - оба являются источниками необходимых для сборки итоговых страниц 
данных.

    @todo Почитать комменты к коду, может ещё что вспомнится, о чём тут можно 
    написать.

Литература
----------
1. [Инверсия зависимостей при проектировании Объектно-Ориентированных систем]
   [agiledev] 
2. [HTTP Cookie][cookie-wiki]
3. [Регулярные выражения][regex-wiki]
4. [PDO: Introduction][pdo-php]
5. [PHP Data Objects][pdo-wiki]
6. [Form (web)][forms-wiki]

[agiledev]: http://wiki.agiledev.ru/doku.php?id=ooad:dependency_injection "Инверсия зависимостей при проектировании Объектно-Ориентированных систем"    
[cookie-wiki]: http://ru.wikipedia.org/wiki/HTTP_cookie "HTTP Cookie"
[regex-wiki]: http://ru.wikipedia.org/wiki/%D0%A0%D0%B5%D0%B3%D1%83%D0%BB%D1%8F%D1%80%D0%BD%D1%8B%D0%B5_%D0%B2%D1%8B%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F "Регулярные выражения"
[pdo-php]: http://www.php.net/manual/en/intro.pdo.php "PDO: Introduction"
[pdo-wiki]: http://ru.wikipedia.org/wiki/PHP_Data_Objects "PHP Data Objects"
[forms-wiki]: http://en.wikipedia.org/wiki/Form_(web) "Form (web)"